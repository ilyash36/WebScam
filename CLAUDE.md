# Инструкции для AI-ассистента - Автосервис CRM

> **Контекст**: Полная техническая документация проекта автосервиса на Django

---

## Контекст проекта

**Технологии**:
- Backend: Python 3.11+, Django 5.0+
- База данных: PostgreSQL (production), SQLite (development)
- Frontend: Django Templates (на первом этапе), готовность к отдельному фронтенду
- API: Django REST Framework (для будущих интеграций с n8n и ботами)
- Деплой: **Docker контейнеризация** (Dockerfile, docker-compose), Gunicorn для production
- Environment variables для секретов через `.env` файл

**Философия проекта**: См. [PHILOSOPHY.md](./PHILOSOPHY.md)

**Этап разработки**: Этап 1 - "Сайт и витрина"

---

## Архитектура проекта

### Структура директорий

```
автосервис/
├── .cursor/
│   └── dev_cache.md          # Кэш разработки для AI
├── config/                    # Основной проект Django
│   ├── settings/
│   │   ├── __init__.py
│   │   ├── base.py           # Базовые настройки
│   │   ├── development.py    # Для разработки
│   │   └── production.py     # Для продакшена
│   ├── urls.py
│   └── wsgi.py
├── apps/
│   ├── core/                 # Базовые модели и утилиты
│   │   ├── models/
│   │   │   ├── __init__.py
│   │   │   ├── client.py     # Модель Клиента
│   │   │   ├── vehicle.py    # Модель Автомобиля
│   │   │   └── base.py       # Базовые абстрактные модели
│   │   ├── admin.py
│   │   └── views.py
│   ├── website/              # Публичный сайт (лендинг, формы)
│   │   ├── templates/
│   │   ├── views.py
│   │   ├── forms.py
│   │   └── urls.py
│   ├── crm/                  # CRM функционал (будущее)
│   └── api/                  # REST API (будущее)
├── static/                   # Статические файлы
│   ├── css/
│   ├── js/
│   │   └── loader.js         # Анимация загрузки (первый визит)
│   └── fonts/
├── media/                    # Загружаемые файлы
├── templates/               # Глобальные шаблоны
├── Dockerfile               # Production образ
├── Dockerfile.dev          # Development образ
├── docker-compose.yml      # Production окружение
├── docker-compose.dev.yml  # Development окружение
├── docker-entrypoint.sh    # Скрипт инициализации
├── .dockerignore           # Исключения для Docker
├── requirements.txt
├── requirements-dev.txt    # Инструменты разработки
├── .env.example
├── manage.py
└── README.md
```

### Принципы архитектуры

1. **Модульность**: Каждое приложение отвечает за свою доменную область
2. **Расширяемость**: Архитектура готова к добавлению новых модулей без переписывания ядра
3. **Событийность**: Важные действия генерируют события (готовность к интеграции с n8n)
4. **API-first мышление**: Даже на первом этапе API проектируется для будущих интеграций

---

## Доменная модель

### Основные сущности (из PHILOSOPHY.md)

1. **Клиент** (`core.models.Client`)
   - Контактные данные (ФИО, телефон, email)
   - Канал привлечения
   - Согласия на коммуникацию
   - История взаимодействий

2. **Автомобиль** (`core.models.Vehicle`)
   - Марка, модель
   - VIN, госномер
   - Пробег
   - Принадлежность клиенту
   - История работ

3. **Обращение/Заказ-наряд** (`core.models.ServiceOrder` - будущее)
   - Жалоба клиента
   - Диагностика
   - Список работ
   - Запчасти
   - Ответственный мастер
   - Статус, сроки

4. **Запчасть** (`core.models.Part` - будущее)
   - Артикул
   - Поставщик
   - Цена закупки/продажи
   - Остатки

5. **Финансы** (`core.models.Payment` - будущее)
   - Счета, оплаты
   - Скидки, задолженности
   - Себестоимость, маржа

### Правила работы с моделями

- Все модели наследуются от базового класса с полями `created_at`, `updated_at`
- Используются человекочитаемые статусы (не "PENDING", а "Ожидает согласования")
- Валидация данных на уровне модели и формы
- Защита от дубликатов (клиенты, автомобили)
- Для уникальных полей задавать человекочитаемые сообщения об ошибках на русском через `error_messages={'unique': '...'}` (например, Client.phone — «Клиент с таким телефоном уже существует.»; Vehicle.vin — «Автомобиль с таким VIN номером уже существует.»)

---

## Технические требования

### Django настройки

**Settings структура**:
- `base.py` - общие настройки для всех окружений
- `development.py` - для локальной разработки (DEBUG=True, SQLite)
- `production.py` - для продакшена (DEBUG=False, PostgreSQL, секреты из env)

**Важные настройки**:
- `LANGUAGE_CODE = 'ru-ru'`
- `TIME_ZONE = 'Europe/Moscow'`
- `USE_I18N = True`
- `USE_TZ = True`
- Статические файлы через `whitenoise` или nginx
- Media файлы через отдельный сервис или локальное хранилище

### База данных

**Development**: SQLite (для простоты)
**Production**: PostgreSQL

**Миграции**:
- Всегда создавать миграции при изменении моделей
- Не редактировать существующие миграции
- Тестировать миграции на тестовых данных

### Безопасность

- Секреты в `.env` файле (не коммитить!)
- `SECRET_KEY` генерируется автоматически при первом запуске
- CSRF защита включена
- SQL injection защита через ORM
- Валидация всех пользовательских входов

---

## Принципы разработки

### Стиль кода

- **PEP 8** для Python кода (строго соблюдается)
  - Максимальная длина строки: 79-88 символов (используется перенос)
  - Импорты: стандартная библиотека → сторонние → локальные
  - Пробелы вокруг операторов и после запятых
  - Пустые строки между функциями/классами (2 строки)
  - Trailing commas в многострочных структурах
- **Docstrings** для всех функций и классов (Google style)
  - Описание функции/класса
  - Args для параметров
  - Returns для возвращаемых значений
- **Type hints** где возможно (Python 3.11+)
  - Аннотации типов для методов и свойств
  - Использование `-> str`, `-> None` и т.д.
- **Именование**: понятные имена на русском в комментариях, английские в коде
- **Форматирование**: все файлы отформатированы согласно PEP 8

### Структура кода

**Модели**:
```python
# apps/core/models/client.py
from django.db import models
from .base import BaseModel

class Client(BaseModel):
    """Клиент автосервиса."""
    
    first_name = models.CharField(
        max_length=100,
        verbose_name="Имя",
    )
    last_name = models.CharField(
        max_length=100,
        verbose_name="Фамилия",
    )
    phone = models.CharField(
        max_length=20,
        unique=True,
        verbose_name="Телефон",
        error_messages={
            'unique': 'Клиент с таким телефоном уже существует.',
        },
    )
    email = models.EmailField(
        blank=True,
        null=True,
        verbose_name="Email",
    )
    
    class Meta:
        """Метаданные модели."""
        
        verbose_name = "Клиент"
        verbose_name_plural = "Клиенты"
        ordering = ['-created_at']
    
    def __str__(self) -> str:
        """Строковое представление объекта."""
        name = f"{self.first_name} {self.last_name}".strip()
        return f"{name} ({self.phone})"
```

**Представления**:
- Использовать class-based views где уместно
- Разделение логики: views только для HTTP, бизнес-логика в сервисах
- Обработка ошибок через try-except с логированием
- Docstrings для всех методов с описанием Args и Returns
- Длинные строки разбиваются на несколько с переносом

**Формы**:
- Django Forms для простых форм
- Валидация на уровне формы и модели
- Человекочитаемые сообщения об ошибках (в т.ч. для уникальных полей — задавать в модели и при необходимости переопределять в форме, например в `BookingForm` для поля `phone`)

**Шаблоны**:
- Базовый шаблон с блокируемой структурой
- Переиспользование компонентов (include)
- Минимум логики в шаблонах

### Обработка ошибок

- Все исключения логируются
- Пользователю показываются понятные сообщения
- Технические детали только в логах

### Логирование

```python
import logging

logger = logging.getLogger(__name__)

# Использование
logger.info("Клиент создан", extra={'client_id': client.id})
logger.error("Ошибка создания клиента", exc_info=True)
```

---

## Работа с БД

### Миграции

```bash
# Создать миграции
python manage.py makemigrations

# Применить миграции
python manage.py migrate

# Откатить миграцию
python manage.py migrate app_name previous_migration_name
```

### Запросы

- Использовать ORM, избегать raw SQL
- Оптимизировать запросы (select_related, prefetch_related)
- Индексы для часто используемых полей поиска

### Тестовые данные

- Фикстуры для базовых данных
- Management команды для генерации тестовых данных

---

## Этап 1: Сайт и витрина

### Текущие задачи

1. **Лендинг/сайт**:
   - Главная страница с описанием услуг
   - Страница "О нас"
   - Страница "Услуги и цены"
   - Страница "Контакты"

2. **Формы**:
   - Форма записи на обслуживание
   - Форма обратной связи
   - Форма записи на приём (estimate)

3. **Базовый личный кабинет** (заглушки):
   - Страница входа/регистрации
   - Профиль клиента
   - История обращений (пока пусто)

### Дизайн (Chernyavskiy A-Tech)

- **Бренд**: Chernyavskiy A-Tech (Автосервис Андрея Чернявского)
- **Палитра**: чёрный (#0a0a0a), золотой (#d4af37), белый
- **Шрифты**: `static/css/fonts.css` — KOT-Eitai Gothic Bold, Century Old Style Std, Goudy Old Style, DwarvenStonecraftCyrExtended; KOT и Century — CDN приоритет (стабильность в Docker); preload в base.html
- **Скругления**: эллиптические (кривые Безье) через `--radius-bezier-sm/md/lg`
- **Контакты**: Телефон +7 (950) 757-06-06 — ссылка на t.me/+79507570606; адрес Воронеж, Кривошеина 7а — ссылка на Яндекс.Карты; режим работы Пн-Вс 10:00–20:00, по предварительной записи
- **Футер**: «Compose & Code by 1nowen» — ссылка на 1nowen.com, шрифт KOT; три столбца (Chernyavskiy A-Tech, Контакты, Быстрые ссылки) — grid 3 колонки по центру (max-width 960px); анимация загрузки 1,5 с при первом визите (`static/js/loader.js`)
- **Страница «Услуги»**: текст о принципе технической диагностики в карточке; выравнивание по ширине; жирные акценты на ключевых фразах
- **Страница «О нас»**: ценности включают Кайдзен (философия Toyota Production System)

### Структура шаблонов

```
templates/
├── base.html              # Базовый шаблон
├── website/
│   ├── index.html         # Главная
│   ├── about.html         # О нас
│   ├── services.html      # Услуги
│   ├── contacts.html      # Контакты
│   ├── booking.html       # Форма записи
│   ├── feedback.html      # Форма обратной связи
│   └── estimate_request.html  # Запись на приём
└── accounts/
    ├── login.html
    ├── register.html
    └── profile.html
```

---

## Будущие этапы (архитектурная готовность)

### Этап 2: CRM и учёт

- Модели данных для всех сущностей
- Внутренние кабинеты (мастер, админ, бухгалтер, владелец)
- Отчёты и аналитика

### Этап 3: Автоматизация

- REST API через Django REST Framework
- События для интеграции с n8n
- Боты (Telegram, WhatsApp)

---

## Рекомендации для AI-ассистента

### Что делать

✅ Следовать структуре проекта
✅ Использовать существующие модели и паттерны
✅ Соблюдать PEP 8 во всём коде
✅ Добавлять docstrings и комментарии (Google style)
✅ Использовать type hints где возможно
✅ Валидировать данные
✅ Обрабатывать ошибки
✅ Логировать важные действия
✅ Разбивать длинные строки (макс. 79-88 символов)
✅ Использовать trailing commas в многострочных структурах
✅ Обновлять `.cursor/dev_cache.md` при важных изменениях
✅ Тестировать изменения в Docker окружении
✅ Учитывать Docker при добавлении новых зависимостей

### Что НЕ делать

❌ Не создавать дублирующие модели
❌ Не добавлять "лишние" поля без бизнес-обоснования
❌ Не писать raw SQL без необходимости
❌ Не коммитить секреты в код
❌ Не игнорировать миграции
❌ Не усложнять без необходимости
❌ Не нарушать PEP 8 (длинные строки, неправильные импорты)
❌ Не забывать docstrings для публичных методов
❌ Не использовать неявные типы без type hints

### Перед добавлением новой функции

1. Определить бизнес-проблему, которую решает функция
2. Определить, какие сущности задействованы
3. Проверить, не дублирует ли существующий функционал
4. Спроектировать API (даже если пока только внутренний)
5. Учесть будущие интеграции (n8n, боты)

---

## Глоссарий терминов

- **Клиент** - физическое лицо, обращающееся в автосервис
- **Автомобиль** - транспортное средство клиента
- **Обращение** - факт обращения клиента в автосервис
- **Заказ-наряд** - документ на выполнение работ
- **Запчасть** - деталь для ремонта автомобиля
- **Мастер** - сотрудник, выполняющий работы
- **n8n** - платформа автоматизации бизнес-процессов
- **Docker** - платформа контейнеризации приложений
- **Gunicorn** - WSGI HTTP сервер для Python

---

## Ссылки

- [PHILOSOPHY.md](./PHILOSOPHY.md) - Философия проекта
- [.cursor/dev_cache.md](./.cursor/dev_cache.md) - Кэш разработки
- [DOCKER.md](./DOCKER.md) - Инструкции по Docker
- [SETUP.md](./SETUP.md) - Инструкция по установке
- [CONTRIBUTING.md](./CONTRIBUTING.md) - Руководство по внесению вклада