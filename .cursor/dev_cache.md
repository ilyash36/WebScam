# Кэш разработки - Автосервис CRM

> **Назначение**: Сжатая информация для быстрого понимания контекста AI-моделями + кэш истории разработки

---

## Быстрый обзор

Проект автосервиса на Django - цифровой "мозг" автосервиса с поэтапным развитием: сайт → CRM → автоматизация. Текущий этап: создание простейшего сайта-витрины с формами записи. Backend: Python/Django, БД: PostgreSQL (prod), SQLite (dev). Архитектура готова к интеграциям с n8n и ботами. **Проект полностью контейнеризирован через Docker** - готов к деплою.

---

## Архитектура

**Структура**: Модульная архитектура с приложениями `core`, `website`, `crm`, `api`. Settings разделены на `base`, `development`, `production`. Модели в `apps/core/models/`, шаблоны в `templates/`, статика в `static/`.

**Принципы**: Модульность, расширяемость, событийность, API-first мышление. Ядро - Django backend + БД, n8n - внешний оркестратор, боты/фронт - тонкие клиенты.

---

## Ключевые компоненты

- **apps/core/** - базовые модели (Client, Vehicle) и утилиты
- **apps/website/** - публичный сайт (лендинг, формы записи)
- **apps/crm/** - CRM функционал (будущее)
- **apps/api/** - REST API (будущее)
- **config/** - настройки Django проекта
- **Docker конфигурация**:
  - `Dockerfile` - production образ с gunicorn
  - `Dockerfile.dev` - development образ с hot-reload
  - `docker-compose.yml` - production окружение
  - `docker-compose.dev.yml` - development окружение
  - `docker-entrypoint.sh` - автоматическая инициализация

---

## Важные детали реализации

- Все модели наследуются от BaseModel с `created_at`, `updated_at`
- Человекочитаемые статусы (не "PENDING", а "Ожидает согласования")
- Валидация на уровне модели и формы
- Защита от дубликатов клиентов/автомобилей
- Секреты в `.env` (не коммитить!)
- Логирование важных действий
- **PEP 8 строго соблюдается**: длина строк до 79-88 символов, правильные импорты, trailing commas
- **Docstrings** для всех классов и методов (Google style)
- **Type hints** для методов и свойств (`-> str`, `-> None`)
- Длинные строки разбиваются на несколько с переносом
- **Docker**: проект полностью контейнеризирован, автоматические миграции при запуске, health checks для БД

---

## Часто используемые функции

### Создание модели клиента
```python
from apps.core.models import Client

client = Client.objects.create(
    first_name="Иван",
    last_name="Иванов",
    phone="+79991234567",
    email="ivan@example.com"
)
```

### Поиск клиента по телефону
```python
try:
    client = Client.objects.get(phone=phone)
except Client.DoesNotExist:
    client = None
```

### Логирование
```python
import logging
logger = logging.getLogger(__name__)
logger.info("Действие выполнено", extra={'key': value})
```

---

## Паттерны кода

### Базовая модель
```python
from django.db import models

class BaseModel(models.Model):
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        abstract = True
```

### Class-based view
```python
from django.views.generic import CreateView
from apps.core.models import Client

class ClientCreateView(CreateView):
    model = Client
    fields = ['first_name', 'last_name', 'phone', 'email']
    template_name = 'website/booking.html'
    success_url = '/success/'
```

---

## История разработки

### Архитектурные решения

- **Модульная структура приложений**: Разделение на `core`, `website`, `crm`, `api` для четкой организации кода и будущего расширения
- **Разделение settings**: `base`, `development`, `production` для разных окружений без дублирования кода
- **BaseModel**: Абстрактная модель с `created_at`/`updated_at` для единообразия всех моделей
- **Этапность разработки**: Сначала простой сайт, затем CRM, затем автоматизация - архитектура готова к росту

### Текущий контекст разработки

- **Работаем над**: Этап 1 "Сайт и витрина" - ЗАВЕРШЁН ✅
  - Создана базовая структура Django проекта
  - Реализованы модели Client и Vehicle
  - Создан публичный сайт с лендингом и формами
  - Формы: запись на обслуживание, обратная связь, заявка на расчёт
- **Важно помнить**: 
  - Архитектура готова к расширению (CRM, API, автоматизация)
  - Все модели следуют доменной модели из PHILOSOPHY.md
  - Формы валидируются на уровне формы и модели
  - Код типизирован и документирован
  - Логирование настроено для отслеживания важных действий

### Часто используемые паттерны

- **BaseModel**: Все модели наследуются от BaseModel для единообразия
- **Class-based views**: Использование CBV для стандартных операций (CreateView, ListView)
- **Логирование**: Все важные действия логируются с контекстом
- **Валидация**: На уровне формы и модели для надежности
- **Docker**: Использование docker-compose для локальной разработки и деплоя

### Важные решения (хронология)

- **2024-12-XX**: Выбран Django как основной фреймворк для backend
- **2024-12-XX**: Определена модульная структура приложений (core, website, crm, api)
- **2024-12-XX**: Решено начать с простого сайта, затем развивать CRM функционал
- **2024-12-XX**: Создана техническая документация (CLAUDE.md) и кэш разработки (dev_cache.md)
- **2024-12-XX**: Реализован Этап 1 - простейший сайт-витрина:
  - Модели Client и Vehicle с валидацией и защитой от дубликатов
  - Формы записи на обслуживание, обратной связи и заявки на расчёт
  - Шаблоны для всех страниц сайта (главная, о нас, услуги, контакты)
  - Базовые CSS стили для современного внешнего вида
  - Логирование всех важных действий
  - Админ-панель для управления клиентами и автомобилями
- **2024-12-XX**: Оптимизация всего кода под стандарт PEP 8:
  - Исправлены длинные строки (разбиты на несколько с переносом)
  - Добавлены docstrings для всех классов и методов (Google style)
  - Добавлены type hints для методов (`-> str`, `-> None`)
  - Исправлен порядок импортов (стандартная библиотека → сторонние → локальные)
  - Добавлены trailing commas в многострочных структурах
  - Улучшено форматирование кода для лучшей читаемости
- **2024-12-XX**: Очистка и оптимизация проекта:
  - Удалены временные файлы (CREATE_ENV.md, CLAUDE_prompt.txt, first_question_cursor.txt)
  - Создан `.env.example` для примера конфигурации
  - Добавлены конфигурационные файлы для инструментов разработки:
    - `setup.cfg` - конфигурация для flake8, isort, mypy
    - `pyproject.toml` - конфигурация для black, isort, pytest
    - `requirements-dev.txt` - инструменты для разработки
    - `Makefile` - команды для разработки
  - Улучшен `.gitignore` (добавлены исключения для кэшей линтеров)
  - Создан `CONTRIBUTING.md` - руководство по внесению вклада
  - Обновлена документация (README.md, SETUP.md)
- **2024-12-XX**: Docker контейнеризация проекта:
  - Создан `Dockerfile` для production (gunicorn, оптимизированный образ)
  - Создан `Dockerfile.dev` для разработки (runserver, hot-reload)
  - Создан `docker-compose.yml` для production окружения
  - Создан `docker-compose.dev.yml` для development окружения
  - Создан `docker-entrypoint.sh` - скрипт инициализации (миграции, статика, суперпользователь)
  - Создан `.dockerignore` для оптимизации сборки
  - Добавлен `gunicorn` в requirements.txt
  - Обновлены настройки production для работы с Docker
  - Создан `DOCKER.md` с подробными инструкциями
  - Проект готов к деплою через Docker

---

## Ссылки

- [CLAUDE.md](../CLAUDE.md) - Полная техническая документация
- [PHILOSOPHY.md](../PHILOSOPHY.md) - Философия проекта
