# Кэш разработки - Автосервис CRM

> **Назначение**: Сжатая информация для быстрого понимания контекста AI-моделями + кэш истории разработки

---

## Быстрый обзор

Проект автосервиса Chernyavskiy A-Tech на Django — цифровой «мозг» автосервиса с поэтапным развитием: сайт → CRM → автоматизация. Текущий этап: сайт-витрина с формами записи. Backend: Python/Django, БД: PostgreSQL (prod), SQLite (dev). **Проект полностью контейнеризирован через Docker** — готов к деплою. Ветки: `main`, `dev`, `registration`.

**Брендинг**: Chernyavskiy A-Tech. Палитра: чёрный (#0a0a0a), золотой (#d4af37), белый. Шрифты: KOT-Eitai Gothic Bold, Century Old Style Std, Goudy Old Style (Sorts Mill Goudy), DwarvenStonecraftCyrExtended (опционально).

**OCR СТС (2026-02)**: Вся логика распознавания и парсинга вынесена в облачный Yandex Workflow (Vision + AI Agent). Django только отправляет `image_base64` и получает JSON. Локальный парсер, Vision API и RF_STS_Documentation удалены.

---

## Архитектура

**Структура**: Модульная архитектура с приложениями `core`, `website`, `crm`, `api`. Settings разделены на `base`, `development`, `production`. Модели в `apps/core/models/`, шаблоны в `templates/`, статика в `static/`.

**Принципы**: Модульность, расширяемость, событийность, API-first мышление. Ядро - Django backend + БД, n8n - внешний оркестратор, боты/фронт - тонкие клиенты.

---

## Ключевые компоненты

- **apps/core/** - базовые модели (Client, Vehicle) и утилиты
- **apps/website/** - публичный сайт (лендинг, формы записи); OCR СТС через облачный Workflow (`ocr/workflow_ocr.py`)
- **apps/crm/** - CRM функционал (будущее)
- **apps/api/** - REST API (будущее)
- **config/** - настройки Django проекта
- **static/js/loader.js** - анимация загрузки (первый визит)
- **Docker конфигурация**:
  - `Dockerfile` - production образ с gunicorn
  - `Dockerfile.dev` - development образ с hot-reload
  - `docker-compose.yml` - production окружение
  - `docker-compose.dev.yml` - development окружение
  - `docker-entrypoint.sh` - автоматическая инициализация

---

## Важные детали реализации

- Все модели наследуются от BaseModel с `created_at`, `updated_at`
- Человекочитаемые статусы (не "PENDING", а "Ожидает согласования")
- Валидация на уровне модели и формы
- Защита от дубликатов клиентов/автомобилей
- **Сообщения об ошибках уникальности** на корректном русском: `Client.phone` — «Клиент с таким телефоном уже существует.»; `Vehicle.vin` — «Автомобиль с таким VIN номером уже существует.» (через `error_messages={'unique': '...'}` в модели и при необходимости в форме)
- Секреты в `.env` (не коммитить!)
- Логирование важных действий
- **PEP 8 строго соблюдается**: длина строк до 79-88 символов, правильные импорты, trailing commas
- **Docstrings** для всех классов и методов (Google style)
- **Type hints** для методов и свойств (`-> str`, `-> None`)
- Длинные строки разбиваются на несколько с переносом
- **Docker**: проект полностью контейнеризирован, автоматические миграции при запуске, health checks для БД; в `Dockerfile.dev` используется `dos2unix` для `docker-entrypoint.sh` (корректная работа на Windows с CRLF)
- **Дизайн**: Палитра чёрный/золотой/белый; эллиптические скругления (кривые Безье) через CSS-переменные `--radius-bezier-sm/md/lg`; шрифты в `static/css/fonts.css`; KOT и Century — CDN приоритет (для стабильности в Docker/Windows); preload для основных шрифтов в base.html
- **Навигация**: На странице /estimate/ — кнопка «Главная» вместо «Записаться»; на остальных страницах — «Записаться» без «Главная»
- **OCR СТС**: облачный Workflow (Vision + AI Agent) в Yandex Cloud; Django отправляет `image_base64`, получает JSON с полями формы; `apps/website/ocr/workflow_ocr.py`; требуется `WORKFLOW_OCR_URL` и `WORKFLOW_OCR_SECRET` в `.env`; при отсутствии — 503
- **Контакты**: Телефон — ссылка на t.me/+79507570606; адрес «Воронеж, Кривошеина 7а» — ссылка на Яндекс.Карты (координаты 51.637890, 39.153217); режим работы Пн-Вс: 10:00–20:00, по предварительной записи; класс `.link-address` для единого стиля
- **Футер**: «Compose & Code by 1nowen» — ссылка на 1nowen.com; шрифт KOT-Eitai Gothic Bold; «wen» с белым фоном и чёрными буквами; анимация увеличения при наведении; три столбца (Chernyavskiy A-Tech, Контакты, Быстрые ссылки) выровнены по центру страницы через grid (3 колонки, max-width 960px)
- **Загрузка**: `static/js/loader.js` — анимация 1,5 с при первой загрузке (referrer не с сайта); при навигации внутри сайта — без анимации; inline-скрипт в head для мгновенного skip
- **Страница «Услуги»**: текст о принципе технической диагностики в карточке (service-item--text); выравнивание по ширине; жирные акценты на ключевых фразах

---

## Часто используемые функции

### Создание модели клиента
```python
from apps.core.models import Client

client = Client.objects.create(
    first_name="Иван",
    last_name="Иванов",
    phone="+79991234567",
    email="ivan@example.com"
)
```

### Поиск клиента по телефону
```python
try:
    client = Client.objects.get(phone=phone)
except Client.DoesNotExist:
    client = None
```

### Логирование
```python
import logging
logger = logging.getLogger(__name__)
logger.info("Действие выполнено", extra={'key': value})
```

---

## Паттерны кода

### Базовая модель
```python
from django.db import models

class BaseModel(models.Model):
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        abstract = True
```

### Class-based view
```python
from django.views.generic import CreateView
from apps.core.models import Client

class ClientCreateView(CreateView):
    model = Client
    fields = ['first_name', 'last_name', 'phone', 'email']
    template_name = 'website/booking.html'
    success_url = '/success/'
```

---

## История разработки

### Архитектурные решения

- **Модульная структура приложений**: Разделение на `core`, `website`, `crm`, `api` для четкой организации кода и будущего расширения
- **Разделение settings**: `base`, `development`, `production` для разных окружений без дублирования кода
- **BaseModel**: Абстрактная модель с `created_at`/`updated_at` для единообразия всех моделей
- **Этапность разработки**: Сначала простой сайт, затем CRM, затем автоматизация - архитектура готова к росту

### Текущий контекст разработки

- **Работаем над**: Этап 1 "Сайт и витрина" - ЗАВЕРШЁН ✅
  - Создана базовая структура Django проекта
  - Реализованы модели Client и Vehicle
  - Создан публичный сайт с лендингом и формами
  - Формы: запись на обслуживание, обратная связь, заявка на расчёт
- **Важно помнить**: 
  - Архитектура готова к расширению (CRM, API, автоматизация)
  - Все модели следуют доменной модели из PHILOSOPHY.md
  - Формы валидируются на уровне формы и модели
  - Код типизирован и документирован
  - Логирование настроено для отслеживания важных действий

### Часто используемые паттерны

- **BaseModel**: Все модели наследуются от BaseModel для единообразия
- **Class-based views**: Использование CBV для стандартных операций (CreateView, ListView)
- **Логирование**: Все важные действия логируются с контекстом
- **Валидация**: На уровне формы и модели для надежности
- **Docker**: Использование docker-compose для локальной разработки и деплоя

### Важные решения (хронология)

- **2026-02**: Выбран Django как основной фреймворк для backend
- **2026-02**: Определена модульная структура приложений (core, website, crm, api)
- **2026-02**: Решено начать с простого сайта, затем развивать CRM функционал
- **2026-02**: Создана техническая документация (CLAUDE.md) и кэш разработки (dev_cache.md)
- **2026-02**: Реализован Этап 1 - простейший сайт-витрина:
  - Модели Client и Vehicle с валидацией и защитой от дубликатов
  - Формы записи на обслуживание, обратной связи и заявки на расчёт
  - Шаблоны для всех страниц сайта (главная, о нас, услуги, контакты)
  - Базовые CSS стили для современного внешнего вида
  - Логирование всех важных действий
  - Админ-панель для управления клиентами и автомобилями
- **2026-02**: Оптимизация всего кода под стандарт PEP 8:
  - Исправлены длинные строки (разбиты на несколько с переносом)
  - Добавлены docstrings для всех классов и методов (Google style)
  - Добавлены type hints для методов (`-> str`, `-> None`)
  - Исправлен порядок импортов (стандартная библиотека → сторонние → локальные)
  - Добавлены trailing commas в многострочных структурах
  - Улучшено форматирование кода для лучшей читаемости
- **2026-02**: Очистка и оптимизация проекта:
  - Удалены временные файлы (CREATE_ENV.md, CLAUDE_prompt.txt, first_question_cursor.txt)
  - Создан `.env.example` для примера конфигурации
  - Добавлены конфигурационные файлы для инструментов разработки:
    - `setup.cfg` - конфигурация для flake8, isort, mypy
    - `pyproject.toml` - конфигурация для black, isort, pytest
    - `requirements-dev.txt` - инструменты для разработки
    - `Makefile` - команды для разработки
  - Улучшен `.gitignore` (добавлены исключения для кэшей линтеров)
  - Создан `CONTRIBUTING.md` - руководство по внесению вклада
  - Обновлена документация (README.md, SETUP.md)
- **2026-02**: Docker контейнеризация проекта:
  - Создан `Dockerfile` для production (gunicorn, оптимизированный образ)
  - Создан `Dockerfile.dev` для разработки (runserver, hot-reload)
  - Создан `docker-compose.yml` для production окружения
  - Создан `docker-compose.dev.yml` для development окружения
  - Создан `docker-entrypoint.sh` - скрипт инициализации (миграции, статика, суперпользователь)
  - Создан `.dockerignore` для оптимизации сборки
  - Добавлен `gunicorn` в requirements.txt
  - Обновлены настройки production для работы с Docker
  - Создан `DOCKER.md` с подробными инструкциями
  - Проект готов к деплою через Docker
- **2026-02**: Git-ветки: `main` (базовая), `dev` (от main), `registration` (от dev). Локальный запуск через Docker: `docker-compose -f docker-compose.dev.yml up --build -d`; требуется `.env` из `.env.example`.
- **2026-02**: Исправление сообщений об ошибках уникальности на корректный русский: для поля «Телефон» в модели Client — «Клиент с таким телефоном уже существует.»; для поля «VIN номер» в модели Vehicle — «Автомобиль с таким VIN номером уже существует.» Добавлено переопределение в `BookingForm` для поля `phone`. В `Dockerfile.dev` добавлен `dos2unix` для корректной работы entrypoint на Windows.
- **2026-02**: Ребрендинг и редизайн (ветка registration):
  - Бренд: Chernyavskiy A-Tech (вместо «Автосервис»)
  - Палитра: чёрный (#0a0a0a), золотой (#d4af37), белый
  - Шрифты: KOT-Eitai Gothic Bold, Century Old Style Std, Goudy Old Style (Sorts Mill Goudy), DwarvenStonecraftCyrExtended (локально)
  - Эллиптические скругления (кривые Безье) вместо стандартного border-radius
  - Услуги: Диагностика, Техническое обслуживание, Ремонт узлов и агрегатов (убраны шиномонтаж и др.)
  - Контактный телефон: +7 (950) 757-06-06
  - Страница /estimate/: «Запись на приём» вместо «Заявка на расчёт»; кнопка «Главная» в шапке; без кнопки «Записаться»
  - На странице услуг кнопка «Записаться» вместо «Запросить расчёт»
- **2026-02**: Доработки UI и UX:
  - Футер «Compose & Code by 1nowen» (1nowen_futer.md): ссылка на 1nowen.com, шрифт сайта, «wen» с белым фоном, анимация scale при наведении
  - Контакты: адрес «Воронеж, Кривошеина 7а» — ссылка на Яндекс.Карты; телефон — ссылка на Telegram
  - Заголовок главной: «Автосервис Андрея Чернявского»
  - Карточки услуг: центрирование текста (flex, align-items, justify-content)
  - Плавная загрузка: `static/js/loader.js` + inline-скрипт в head; показ только при первой загрузке (document.referrer); при навигации внутри сайта — без анимации (html.skip-loader)
  - Убрана фраза «Все права защищены» из футера
- **2026-02**: Страница «Услуги»:
  - Заголовок «Услуги»; карточки заменены на текст о принципе технической диагностики
  - Текст в карточке service-item--text; выравнивание по ширине (text-align: justify)
  - Жирные акценты: «принцип технической диагностики», «избегая ненужных замен...»
  - CTA: «Точную стоимость работ можно узнать после диагностики» (шрифт KOT), кнопка «Записаться»
  - Длительность лоадера увеличена до 1,5 с
- **2026-02**: Контент страниц:
  - Контакты: режим работы Пн-Вс 10:00–20:00, по предварительной записи
  - О нас: «Профессионализм — труд исключительно опытного мастера»; добавлена ценность «Кайдзен — философия постоянного совершенствования Toyota Production System»
- **2026-02**: Шрифты и футер:
  - KOT-Eitai Gothic Bold: CDN приоритет (db.onlinewebfonts.com) для стабильной работы в Docker на Windows; локальные woff2 как fallback
  - Preload шрифтов KOT и Century в base.html для ускорения загрузки
  - Футер «Compose & Code by 1nowen» — шрифт KOT
  - Три столбца футера (Chernyavskiy A-Tech, Контакты, Быстрые ссылки): grid 3 колонки, центрирование (max-width 960px, margin auto)
- **2026-02**: OCR СТС полностью перенесён в облако (крупный рефакторинг):
  - **Удалено**: локальный парсер `sts_parser.py`, Vision `yandex_vision.py`, справочник марок `brands.py`, вся директория `RF_STS_Documentation/` (спецификация, Brands.txt, Приказ МВД N 267), скрипт `scripts/generate_brands.py`
  - **Архитектура**: Django → POST `image_base64` + `secret` → Workflow (Vision + AI Agent) → polling результата → JSON с полями формы
  - **Обязательные переменные**: `WORKFLOW_OCR_URL`, `WORKFLOW_OCR_SECRET`; при отсутствии — 503
  - **Опционально для polling**: `YANDEX_VISION_API_KEY`, `YANDEX_FOLDER_ID` (для авторизации запросов к execution API)
  - **Тест**: `python scripts/test_workflow_ocr.py путь/к/изображению.jpg` — отправляет image_base64 в workflow

---

## Ссылки

- [CLAUDE.md](../CLAUDE.md) - Полная техническая документация
- [PHILOSOPHY.md](../PHILOSOPHY.md) - Философия проекта
